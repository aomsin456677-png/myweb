<div id="app"></div>

<style>
@import url('https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700&display=swap');

*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  font-family:'Prompt',sans-serif;
}

body{
  background:linear-gradient(135deg,#141e30,#243b55);
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  color:white;
}

.container{
  width:95%;
  max-width:1100px;
  text-align:center;
}

.glass{
  background:rgba(255,255,255,0.1);
  backdrop-filter:blur(20px);
  padding:30px;
  border-radius:25px;
}

button{
  padding:8px 15px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  margin:5px;
  font-weight:600;
}

.blue{background:#0072ff;color:white;}
.green{background:#2ecc71;color:white;}
.red{background:#e74c3c;color:white;}
.gray{background:#95a5a6;color:white;}

input, textarea{
  width:100%;
  padding:8px;
  border-radius:8px;
  border:none;
  margin:6px 0;
}

textarea{
  height:100px;
  resize:none;
}

table{
  width:100%;
  background:white;
  color:#333;
  border-collapse:collapse;
  font-size:13px;
}

th, td{
  padding:8px;
  border-bottom:1px solid #ddd;
}

th{
  background:#0072ff;
  color:white;
}

.status-approved{
  background:#2ecc71;
  color:white;
  font-weight:700;
}

.status-rejected{
  background:#e74c3c;
  color:white;
  font-weight:700;
}

.status-pending{
  background:#f1c40f;
  color:black;
  font-weight:600;
}
</style>

<script>
const ADMIN_USERNAME = "AOMSIN";
const ADMIN_PASSWORD = "451122";

let currentUserPhone = "";

// หน้าแรก
function showHome(){
  document.getElementById("app").innerHTML = `
  <div class="container">
    <div class="glass">
      <h1>รับแจ้งเหตุปัญหาภายในโรงเรียนพัฒนานิคม</h1>
      <button class="blue" onclick="showUserLogin()">เริ่มส่งปัญหา</button>
      <br>
      <button class="blue" onclick="showAdminLogin()">เข้าสู่ระบบสภานักเรียน</button>
    </div>
  </div>`;
}

// ล็อกอินผู้ใช้
function showUserLogin(){
  document.getElementById("app").innerHTML = `
  <div class="container">
    <div class="glass">
      <h2>เข้าสู่ระบบด้วยเบอร์โทร</h2>
      <input id="phone" placeholder="กรอกเบอร์โทร">
      <button class="blue" onclick="loginUser()">ยืนยัน</button>
      <button class="gray" onclick="showHome()">กลับ</button>
    </div>
  </div>`;
}

function loginUser(){
  let phone = document.getElementById("phone").value;
  if(!phone){ alert("กรอกเบอร์ก่อน"); return; }
  currentUserPhone = phone;
  showUserDashboard();
}

// หน้าสถานะผู้ใช้
function showUserDashboard(){
  let data = JSON.parse(localStorage.getItem("problems")) || [];
  let myProblems = data.filter(p=>p.phone===currentUserPhone);

  let rows = "";

  if(myProblems.length===0){
    rows = `<tr><td colspan="5">ยังไม่เคยแจ้งปัญหา</td></tr>`;
  }else{
    myProblems.forEach((item,index)=>{

      let displayStatus="รอยืนยัน";
      let statusClass="status-pending";

      if(item.status==="อนุมัติ"){
        displayStatus="อนุมัติแล้ว";
        statusClass="status-approved";
      }
      if(item.status==="ไม่อนุมัติ"){
        displayStatus="ไม่อนุมัติ";
        statusClass="status-rejected";
      }

      rows+=`
      <tr class="${statusClass}">
        <td>${index+1}</td>
        <td>${item.fullname}</td>
        <td>${item.problem}</td>
        <td>${item.time}</td>
        <td>${displayStatus}</td>
      </tr>`;
    });
  }

  document.getElementById("app").innerHTML=`
  <div class="container">
    <div class="glass">
      <h2>สถานะการแจ้งปัญหา</h2>
      <table>
        <tr>
          <th>ลำดับ</th>
          <th>ชื่อ</th>
          <th>ปัญหา</th>
          <th>เวลา</th>
          <th>สถานะ</th>
        </tr>
        ${rows}
      </table>
      <br>
      <button class="green" onclick="showForm()">ส่งแจ้งปัญหาเพิ่มเติม</button>
      <button class="gray" onclick="showHome()">ออกจากระบบ</button>
    </div>
  </div>`;
}

// ฟอร์มแจ้ง
function showForm(){
  document.getElementById("app").innerHTML=`
  <div class="container">
    <div class="glass">
      <h2>แจ้งปัญหา</h2>
      <input id="fullname" placeholder="ชื่อ - นามสกุล">
      <input id="classroom" placeholder="ชั้น">
      <input id="email" type="email" placeholder="อีเมล">
      <textarea id="problem" placeholder="รายละเอียดปัญหา"></textarea>
      <button class="blue" onclick="submitProblem()">ส่งปัญหา</button>
      <button class="gray" onclick="showUserDashboard()">กลับ</button>
    </div>
  </div>`;
}

function submitProblem(){
  let fullname=document.getElementById("fullname").value;
  let classroom=document.getElementById("classroom").value;
  let email=document.getElementById("email").value;
  let problem=document.getElementById("problem").value;

  if(!fullname || !classroom || !email || !problem){
    alert("กรอกข้อมูลให้ครบก่อน");
    return;
  }

  let data=JSON.parse(localStorage.getItem("problems"))||[];

  data.push({
    id:Date.now(),
    phone:currentUserPhone,
    fullname,
    classroom,
    email,
    problem,
    time:new Date().toLocaleString("th-TH"),
    status:""
  });

  localStorage.setItem("problems",JSON.stringify(data));
  showUserDashboard();
}

// แอดมิน
function showAdminLogin(){
  document.getElementById("app").innerHTML=`
  <div class="container">
    <div class="glass">
      <h2>เข้าสู่ระบบสภานักเรียน</h2>
      <input id="user" placeholder="ชื่อผู้ใช้">
      <input id="pass" type="password" placeholder="รหัสผ่าน">
      <button class="blue" onclick="adminLogin()">เข้าสู่ระบบ</button>
      <button class="gray" onclick="showHome()">กลับ</button>
      <p id="err" style="color:red;"></p>
    </div>
  </div>`;
}

function adminLogin(){
  if(user.value===ADMIN_USERNAME && pass.value===ADMIN_PASSWORD){
    showAdminDashboard();
  }else{
    document.getElementById("err").innerText="รหัสไม่ถูกต้อง";
  }
}

function showAdminDashboard(){
  let data=JSON.parse(localStorage.getItem("problems"))||[];

  // เรียงลำดับ: ยังไม่กดก่อน
  data.sort((a,b)=>{
    if(!a.status && b.status) return -1;
    if(a.status && !b.status) return 1;
    return 0;
  });

  let rows="";

  if(data.length===0){
    rows=`<tr><td colspan="8">ไม่มีข้อมูล</td></tr>`;
  }else{
    data.forEach((item,index)=>{

      let statusClass="";
      let statusText="รอยืนยัน";

      if(item.status==="อนุมัติ"){
        statusClass="status-approved";
        statusText="อนุมัติแล้ว";
      }

      if(item.status==="ไม่อนุมัติ"){
        statusClass="status-rejected";
        statusText="ไม่อนุมัติ";
      }

      if(!item.status){
        statusClass="status-pending";
      }

      rows+=`
      <tr class="${statusClass}">
        <td>${index+1}</td>
        <td>${item.phone}</td>
        <td>${item.fullname}</td>
        <td>${item.classroom}</td>
        <td>${item.email}</td>
        <td>${item.problem}</td>
        <td>${statusText}</td>
        <td>
          <button class="green" onclick="updateStatus(${item.id},'อนุมัติ')">✔</button>
          <button class="red" onclick="updateStatus(${item.id},'ไม่อนุมัติ')">✖</button>
        </td>
      </tr>`;
    });
  }

  document.getElementById("app").innerHTML=`
  <div class="container">
    <div class="glass">
      <h2>ระบบหลังบ้านสภานักเรียน</h2>
      <table>
        <tr>
          <th>ลำดับ</th>
          <th>เบอร์</th>
          <th>ชื่อ</th>
          <th>ชั้น</th>
          <th>อีเมล</th>
          <th>ปัญหา</th>
          <th>สถานะ</th>
          <th>จัดการ</th>
        </tr>
        ${rows}
      </table>
      <br>
      <button class="gray" onclick="showHome()">ออกจากระบบ</button>
    </div>
  </div>`;
}

function updateStatus(id,status){
  let data=JSON.parse(localStorage.getItem("problems"));
  data=data.map(item=>{
    if(item.id===id){ item.status=status; }
    return item;
  });
  localStorage.setItem("problems",JSON.stringify(data));
  showAdminDashboard();
}

showHome();
</script>
